var tb_position;window.wp=window.wp||{},function(n){var i,s=wp.themes=wp.themes||{};s.data=_wpThemeSettings,i=s.data.l10n,_.extend(s,{model:{},view:{},routes:{},router:{},template:wp.template}),s.model=Backbone.Model.extend({}),s.view.Appearance=wp.Backbone.View.extend({el:"#wpbody-content .wrap .theme-browser",window:n(window),page:0,initialize:function(){_.bindAll(this,"scroller"),this.window.bind("scroll",_.throttle(this.scroller,300))},render:function(){this.view=new s.view.Themes({collection:this.collection,parent:this}),this.search(),this.view.render(),this.$el.empty().append(this.view.el).addClass("rendered"),this.$el.append('<br class="clear"/>')},search:function(){var e;1!==s.data.themes.length&&((e=new s.view.Search({collection:this.collection})).render(),n("#wpbody h2:first").append(n.parseHTML('<label class="screen-reader-text" for="theme-search-input">'+i.search+"</label>")).append(e.el))},scroller:function(){var e=this,t=this.window.scrollTop()+e.window.height(),e=e.$el.offset().top+e.$el.outerHeight(!1)-e.window.height();Math.round(.9*e)<t&&this.trigger("theme:scroll")}}),s.Collection=Backbone.Collection.extend({model:s.model,terms:"",doSearch:function(e){this.terms!==e&&(this.terms=e,0<this.terms.length&&this.search(this.terms),""===this.terms&&this.reset(s.data.themes),this.trigger("update"))},search:function(t){var i,e,n;this.reset(s.data.themes,{silent:!0}),t=t.replace(" ",")(?=.*"),i=new RegExp("^(?=.*"+t+").+","i"),e=this.filter(function(e){return n=_.union(e.get("name"),e.get("id"),e.get("description"),e.get("author"),e.get("tags")),i.test(e.get("author"))&&2<t.length&&e.set("displayAuthor",!0),i.test(n)}),this.reset(e)},paginate:function(e){var t=this;return e=e||0,t=_(t.rest(15*e)),t=_(t.first(15))}}),s.view.Theme=wp.Backbone.View.extend({className:"theme",state:"grid",html:s.template("theme"),events:{click:"expand",keydown:"expand",touchend:"expand",touchmove:"preventExpand"},touchDrag:!1,render:function(){var e=this.model.toJSON();this.$el.html(this.html(e)).attr({tabindex:0,"aria-describedby":e.id+"-action "+e.id+"-name"}),this.activeTheme(),this.model.get("displayAuthor")&&this.$el.addClass("display-author")},activeTheme:function(){this.model.get("active")&&this.$el.addClass("active")},expand:function(e){if("keydown"!==(e=e||window.event).type||13===e.which||32===e.which)return!0===this.touchDrag?this.touchDrag=!1:void(n(e.target).is(".theme-actions a")||(s.focusedTheme=this.$el,this.trigger("theme:expand",this.model.cid)))},preventExpand:function(){this.touchDrag=!0}}),s.view.Details=wp.Backbone.View.extend({className:"theme-overlay",events:{click:"collapse","click .delete-theme":"deleteTheme","click .left":"previousTheme","click .right":"nextTheme"},html:s.template("theme-single"),render:function(){var e=this.model.toJSON();this.$el.html(this.html(e)),this.activeTheme(),this.navigation(),this.screenshotCheck(this.$el),this.containFocus(this.$el)},activeTheme:function(){this.$el.toggleClass("active",this.model.get("active"))},containFocus:function(t){var i;_.delay(function(){n(".theme-wrap a.button-primary:visible").focus()},500),t.on("keydown.wp-themes",function(e){9===e.which&&((i=n(e.target)).is("button.left")&&e.shiftKey?(t.find(".theme-actions a:last-child").focus(),e.preventDefault()):i.is(".theme-actions a:last-child")&&(t.find("button.left").focus(),e.preventDefault()))})},collapse:function(e){var t,i=this;e=e||window.event,1!==s.data.themes.length&&(n(e.target).is(".theme-backdrop")||n(e.target).is(".close")||27===e.keyCode)&&(n("body").addClass("closing-overlay"),this.$el.fadeOut(130,function(){n("body").removeClass("theme-overlay-open closing-overlay"),i.closeOverlay(),t=document.body.scrollTop,s.router.navigate(s.router.baseUrl(""),{replace:!0}),document.body.scrollTop=t,s.focusedTheme&&s.focusedTheme.focus()}))},navigation:function(){this.model.cid===this.model.collection.at(0).cid&&this.$el.find(".left").addClass("disabled"),this.model.cid===this.model.collection.at(this.model.collection.length-1).cid&&this.$el.find(".right").addClass("disabled")},closeOverlay:function(){this.remove(),this.unbind(),this.trigger("theme:collapse")},deleteTheme:function(){return confirm(s.data.settings.confirmDelete)},nextTheme:function(){this.trigger("theme:next",this.model.cid)},previousTheme:function(){this.trigger("theme:previous",this.model.cid)},screenshotCheck:function(e){var t=e.find(".screenshot img"),i=new Image;i.src=t.attr("src"),i.width&&i.width<=300&&e.addClass("small-screenshot")}}),s.view.Themes=wp.Backbone.View.extend({className:"themes",$overlay:n("div.theme-overlay"),index:0,count:n(".theme-count"),initialize:function(e){var t=this;this.parent=e.parent,this.setView("grid"),t.currentTheme(),this.listenTo(t.collection,"update",function(){t.parent.page=0,t.currentTheme(),t.render(this)}),this.listenTo(this.parent,"theme:scroll",function(){t.renderThemes(t.parent.page)}),n("body").on("keyup",function(e){t.overlay&&(39===e.keyCode&&t.overlay.nextTheme(),37===e.keyCode&&t.overlay.previousTheme(),27===e.keyCode&&t.overlay.collapse(e))})},render:function(){this.$el.html(""),1===s.data.themes.length&&(this.singleTheme=new s.view.Details({model:this.collection.models[0]}),this.singleTheme.render(),this.$el.addClass("single-theme"),this.$el.append(this.singleTheme.el)),this.renderThemes(this.parent.page),this.count.text(this.collection.length)},renderThemes:function(e){var t=this;t.instance=t.collection.paginate(e),0!==t.instance.length&&(1<=e&&n(".add-new-theme").remove(),t.instance.each(function(e){t.theme=new s.view.Theme({model:e}),t.theme.render(),t.$el.append(t.theme.el),t.listenTo(t.theme,"theme:expand",t.expand,t)}),s.data.settings.canInstall&&this.$el.append('<div class="theme add-new-theme"><a href="'+s.data.settings.installURI+'"><div class="theme-screenshot"><span></span></div><h3 class="theme-name">'+i.addNew+"</h3></a></div>"),this.parent.page++)},currentTheme:function(){var e=this,t=e.collection.findWhere({active:!0});t&&(e.collection.remove(t),e.collection.add(t,{at:0}))},setView:function(e){return e},expand:function(e){var t=this;this.model=t.collection.get(e),s.router.navigate(s.router.baseUrl("?theme="+this.model.id),{replace:!0}),this.setView("detail"),n("body").addClass("theme-overlay-open"),this.overlay=new s.view.Details({model:t.model}),this.overlay.render(),this.$overlay.html(this.overlay.el),this.listenTo(this.overlay,"theme:next",function(){t.next([t.model.cid])}).listenTo(this.overlay,"theme:previous",function(){t.previous([t.model.cid])})},next:function(e){var t=this,e=t.collection.get(e[0]),e=t.collection.at(t.collection.indexOf(e)+1);void 0!==e&&(this.overlay.closeOverlay(),t.theme.trigger("theme:expand",e.cid))},previous:function(e){var t=this,e=t.collection.get(e[0]),e=t.collection.at(t.collection.indexOf(e)-1);void 0!==e&&(this.overlay.closeOverlay(),t.theme.trigger("theme:expand",e.cid))}}),s.view.Search=wp.Backbone.View.extend({tagName:"input",className:"theme-search",id:"theme-search-input",attributes:{placeholder:i.searchPlaceholder,type:"search"},events:{input:"search",keyup:"search",change:"search",search:"search"},search:function(e){"keyup"===e.type&&27===e.which&&(e.target.value=""),this.collection.doSearch(e.target.value),e.target.value?s.router.navigate(s.router.baseUrl("?search="+e.target.value),{replace:!0}):s.router.navigate(s.router.baseUrl(""),{replace:!0})}}),s.routes=Backbone.Router.extend({initialize:function(){this.routes=_.object([])},baseUrl:function(e){return s.data.settings.root+e}}),s.Run={init:function(){this.themes=new s.Collection(s.data.themes),this.view=new s.view.Appearance({collection:this.themes}),this.render()},render:function(){this.view.render(),this.routes(),void 0!==s.data.settings.theme&&""!==s.data.settings.theme&&this.view.view.theme.trigger("theme:expand",this.view.collection.findWhere({id:s.data.settings.theme})),void 0!==s.data.settings.search&&""!==s.data.settings.search&&(n(".theme-search").val(s.data.settings.search),this.themes.doSearch(s.data.settings.search)),window.history&&window.history.pushState&&Backbone.history.start({pushState:!0,silent:!0})},routes:function(){s.router=new s.routes}},jQuery(document).ready(_.bind(s.Run.init,s.Run))}(jQuery),jQuery(document).ready(function(s){tb_position=function(){var e=s("#TB_window"),t=s(window).width(),i=s(window).height(),n=1040<t?1040:t,t=0;s("body.admin-bar").length&&(t=parseInt(jQuery("#wpadminbar").css("height"),10)),e.size()&&(e.width(n-50).height(i-45-t),s("#TB_iframeContent").width(n-50).height(i-75-t),e.css({"margin-left":"-"+parseInt((n-50)/2,10)+"px"}),void 0!==document.body.style.maxWidth&&e.css({top:20+t+"px","margin-top":"0"}))},s(window).resize(function(){tb_position()})});