tinymce.PluginManager.add("wpview",function(d){function e(){return!1}var u,a,p,s,c,n,o,r=tinymce.Env,v=tinymce.util.VK,i=tinymce.dom.TreeWalker,f=!1,l=!0,g=/iPad|iPod|iPhone/.test(navigator.userAgent);function m(e){return w(e,"wpview-wrap")}function w(e,t){for(;e&&e.parentNode;){if(e.className&&-1!==(" "+e.className+" ").indexOf(" "+t+" "))return e;e=e.parentNode}return!1}function b(e){return(e=m(e))?window.decodeURIComponent(d.dom.getAttrib(e,"data-wpview-text")||""):""}function C(e){e.stopPropagation()}function S(e,t){var n=e?"before":"after",e=e?0:1;N(),d.selection.setCursorLocation(d.dom.select(".wpview-selection-"+n,t)[0],e),d.nodeChanged()}function y(e,t,n){var o=d.dom,i=o.create("p");r.ie&&r.ie<11||(i.innerHTML='<br data-mce-bogus="1">'),t?e.parentNode.insertBefore(i,e):o.insertAfter(i,e),N(),t&&n===v.ENTER?S(t,e):d.selection.setCursorLocation(i,0),d.nodeChanged()}function h(e){d.undoManager.transact(function(){y(e),d.dom.remove(e)})}function x(e){var t,n=d.dom;e&&(e!==u?(d.getBody().focus(),N(),u=e,n.setAttrib(e,"data-mce-selected",1),E(e),t=n.create("div",{"class":"wpview-clipboard",contenteditable:"true"},b(e)),d.dom.select(".wpview-body",e)[0].appendChild(t),n.bind(t,"beforedeactivate focusin focusout",C),n.bind(u,"beforedeactivate focusin focusout",C),g?d.selection.select(t):d.selection.select(t,!0),d.nodeChanged(),d.fire("wpview-selected",e)):E(e))}function E(e){var t=0,n=d.$(e).find(".toolbar"),o=tinymce.$(d.editorContainer).find(".mce-toolbar-grp")[0],o=o&&o.getBoundingClientRect().bottom||0;(t=n.length&&d.iframeElement?e.getBoundingClientRect().top+d.iframeElement.getBoundingClientRect().top-o-48:t)<0?n.removeClass("mce-arrow-down").css({top:-1*t-43}):0<t&&!n.hasClass("mce-arrow-down")&&n.addClass("mce-arrow-down").css({top:""})}function N(){var e,t=d.dom;u&&(e=d.dom.select(".wpview-clipboard",u)[0],t.unbind(e),t.remove(e),t.unbind(u,"beforedeactivate focusin focusout click mouseup",C),t.setAttrib(u,"data-mce-selected",null)),u=null}return"undefined"!=typeof wp&&wp.mce?(d.on("BeforeAddUndo",function(e){e.lastLevel&&t(e.level.content)===t(e.lastLevel.content)&&e.preventDefault()}),d.on("BeforeSetContent",function(e){var t;e.content&&(u&&h(u),t=d.selection.getNode(),(!e.content.match(/^\s*(https?:\/\/[^\s"]+)\s*$/i)||"P"===t.nodeName&&t.parentNode===d.getBody()&&d.dom.isEmpty(t))&&(e.content=wp.mce.views.toViews(e.content)))}),d.on("SetContent",function(){wp.mce.views.render()}),d.on("click",function(n){var e,o=n.clientX,i=n.clientY,t=d.getBody(),r=t.getBoundingClientRect(),a=t.firstChild,s=a.getBoundingClientRect(),c=t.lastChild,t=c.getBoundingClientRect();i<s.top&&(e=m(a))?(S(!0,e),n.preventDefault()):i>t.bottom&&(e=m(c))?(S(!1,e),n.preventDefault()):tinymce.each(d.dom.select(".wpview-wrap"),function(e){var t=e.getBoundingClientRect();i>=t.top&&i<=t.bottom&&(o<r.left?(S(!0,e),n.preventDefault()):o>r.right&&(S(!1,e),n.preventDefault()))})}),d.on("init",function(){var n=!1,o=d.selection,e=window.MutationObserver||window.WebKitMutationObserver;d.on("BeforeSetContent",function(){var e,t=m(o.getNode());t&&(!t.nextSibling||m(t.nextSibling)?(e=d.getDoc().createTextNode(""),d.dom.insertAfter(e,t)):e=new i(t.nextSibling,t.nextSibling).next(),o.select(e),o.collapse(!0))}),d.dom.bind(d.getDoc(),"touchmove",function(){n=!0}),d.on("mousedown mouseup click touchend",function(e){var t=m(e.target);if(l=!1,t){if(e.stopImmediatePropagation(),e.preventDefault(),!("touchend"!==e.type&&"mousedown"!==e.type||e.metaKey||e.ctrlKey)){if(d.dom.hasClass(e.target,"edit"))return wp.mce.views.edit(t),d.focus(),!1;if(d.dom.hasClass(e.target,"remove"))return h(t),!1}return"touchend"===e.type&&n?n=!1:x(t),!1}"touchend"!==e.type&&"mousedown"!==e.type||N(),"touchend"===e.type&&n&&(n=!1)},!0),e&&new e(function(){d.fire("wp-body-class-change")}).observe(d.getBody(),{attributes:!0,attributeFilter:["class"]})}),d.on("PreProcess",function(e){tinymce.each(d.dom.select("div[data-wpview-text]",e.node),function(e){e.textContent=e.innerText="Â "})}),d.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<div [^>]*?data-wpview-text="([^"]*)"[^>]*>[\s\S]*?<\/div>/g,function(e,t){return t?"<p>"+window.decodeURIComponent(t)+"</p>":""}))}),d.on("keydown",function(e){var t,n,o,i,r,a,s=e.keyCode,c=d.dom,l=d.selection;u?(e.metaKey||e.ctrlKey)&&s!==v.BACKSPACE&&86!==s||112<=s&&s<=123?(e.metaKey||e.ctrlKey)&&88===s&&(f=u):(n=m(l.getNode()))===u?s===v.LEFT?(S(!0,n),e.preventDefault()):s===v.UP?(n.previousSibling?m(n.previousSibling)?S(!0,n.previousSibling):(N(),l.select(n.previousSibling,!0),l.collapse()):S(!0,n),e.preventDefault()):s===v.RIGHT?(S(!1,n),e.preventDefault()):s===v.DOWN?(n.nextSibling?m(n.nextSibling)?S(!1,n.nextSibling):(N(),l.setCursorLocation(n.nextSibling,0)):S(!1,n),e.preventDefault()):D(s)||(h(u),s!==v.ENTER&&s!==v.DELETE&&s!==v.BACKSPACE||e.preventDefault()):N():e.metaKey||e.ctrlKey||112<=s&&s<=123||(t=l.getNode(),n=m(p=t),l.isCollapsed()||((n=m((i=l.getRng()).endContainer))?(r=i.cloneRange(),l.select(n.previousSibling,!0),l.collapse(),a=l.getRng(),r.setEnd(a.endContainer,a.endOffset),l.setRng(r)):(n=m(i.startContainer))&&((r=i.cloneRange()).setStart(n.nextSibling,0),l.setRng(r))),n?((r=c.hasClass(n,"wpview-selection-before"))||(o=c.hasClass(n,"wpview-selection-after")))&&(D(s)||(o&&s===v.UP||r&&s===v.BACKSPACE?(n.previousSibling?m(n.previousSibling)?S(!1,n.previousSibling):c.isEmpty(n.previousSibling)&&s===v.BACKSPACE?c.remove(n.previousSibling):(l.select(n.previousSibling,!0),l.collapse()):S(!0,n),e.preventDefault()):!o||s!==v.DOWN&&s!==v.RIGHT?!r||s!==v.UP&&s!==v.LEFT?r&&s===v.DOWN?(n.nextSibling?m(n.nextSibling)?S(!0,n.nextSibling):l.setCursorLocation(n.nextSibling,0):S(!1,n),e.preventDefault()):o&&s===v.LEFT||r&&s===v.RIGHT?(x(n),e.preventDefault()):o&&s===v.BACKSPACE?(h(n),e.preventDefault()):o?y(n):r&&y(n,!0,s):(n.previousSibling&&(m(n.previousSibling)?S(s===v.UP,n.previousSibling):(l.select(n.previousSibling,!0),l.collapse())),e.preventDefault()):(n.nextSibling&&(m(n.nextSibling)?S(s===v.RIGHT,n.nextSibling):l.setCursorLocation(n.nextSibling,0)),e.preventDefault()),s===v.ENTER&&e.preventDefault())):e.keyCode===v.BACKSPACE&&(d.dom.isEmpty(t)?(n=m(t.previousSibling))&&(S(!1,n),d.dom.remove(t),e.preventDefault()):(i=l.getRng())&&0===i.startOffset&&0===i.endOffset&&(n=m(t.previousSibling))&&(S(!1,n),e.preventDefault())))}),d.on("keyup",function(){f&&(h(f),f=!1)}),d.on("focus",function(){var e;c=!0,d.dom.addClass(d.getBody(),"has-focus"),l&&(e=m(d.getBody().firstChild))&&S(!0,e),l=!1}),d.on("blur",function(){c=!1,d.dom.removeClass(d.getBody(),"has-focus")}),d.on("NodeChange",function(e){var t=d.dom,n=d.dom.select(".wpview-wrap"),o=e.element.className,i=m(e.element),r=p;p=!1,clearInterval(a),tinymce.each(n,function(e){e.className&&(e.className=e.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),c&&i&&("wpview-selection-before"!==o&&"wpview-selection-after"!==o||!d.selection.isCollapsed()?w(e.element,"wpview-clipboard")||s||(N(),s++,S(!0,i)):(s=0,N(),r!==i.previousSibling?r!==i.nextSibling?(t.addClass(i,o),a=setInterval(function(){t.hasClass(i,"wpview-cursor-hide")?t.removeClass(i,"wpview-cursor-hide"):t.addClass(i,"wpview-cursor-hide")},500)):S(!1,i):S(!0,i)))}),d.on("BeforeExecCommand",function(){var e,t=d.selection.getNode();t&&((o="wpview-selection-before"===t.className)||"wpview-selection-after"===t.className)&&(e=m(t))&&(y(e,o),n=e)}),d.on("ExecCommand",function(){var e;u&&(e=u,N(),x(e)),n&&((e=n[o?"previousSibling":"nextSibling"])&&"P"===e.nodeName&&d.dom.isEmpty(e)&&(d.dom.remove(e),S(o,n)),n=!1)}),d.on("ResolveName",function(e){d.dom.hasClass(e.target,"wpview-wrap")?(e.name=d.dom.getAttrib(e.target,"data-wpview-type")||"wpview",e.stopPropagation()):m(e.target)&&(e.preventDefault(),e.stopPropagation())}),{getViewText:b,setViewText:function(e,t){return!!(e=m(e))&&(d.dom.setAttrib(e,"data-wpview-text",window.encodeURIComponent(t||"")),!0)},getView:m}):{getViewText:e,setViewText:e,getView:e};function t(e){return e.replace(/<div[^>]+data-wpview-text=\"([^"]+)"[^>]*>[\s\S]+?wpview-selection-after[^>]+>(?:&nbsp;|\u00a0)*<\/p><\/div>/g,"$1")}function D(e){return e<=47&&e!==v.SPACEBAR&&e!==v.ENTER&&e!==v.DELETE&&e!==v.BACKSPACE&&(e<37||40<e)||224<=e||144<=e&&e<=150||91<=e&&e<=93||112<=e&&e<=135}});