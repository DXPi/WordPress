tinymce.PluginManager.add("wpeditimage",function(v){var o,t,n,a,b=tinymce.DOM,i=v.settings,c=tinymce.ui.Factory,e=tinymce.each,y=tinymce.Env.iOS,r=!0,s=tinymce.$("#postdivrich");function l(e){return v.dom.getAttrib(e,"data-mce-placeholder")||v.dom.getAttrib(e,"data-mce-object")}function d(){r||o.hide()}function p(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,t,n){var a,i,o,c,r,s=tinymce.trim,l=t.match(/id=['"]([^'"]*)['"] ?/);return(r=(t=(i=(t=(a=(t=l?t.replace(l[0],""):t).match(/align=['"]([^'"]*)['"] ?/))?t.replace(a[0],""):t).match(/class=['"]([^'"]*)['"] ?/))?t.replace(i[0],""):t).match(/width=['"]([0-9]*)['"] ?/))&&(t=t.replace(r[0],"")),c=(c=(n=s(n)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&c[2]?(o=s(c[2]),s(c[1])):(o=s(t).replace(/caption=['"]/,"").replace(/['"]$/,""),n),l=l&&l[1]?l[1].replace(/[<>&]+/g,""):"",a=a&&a[1]?a[1]:"alignnone",i=i&&i[1]?" "+i[1].replace(/[<>&]+/g,""):"",(r=(r=!r&&c?c.match(/width=['"]([0-9]*)['"]/):r)&&r[1]?r[1]:r)&&o?(r=parseInt(r,10),v.getParam("wpeditimage_html5_captions")||(r+=10),'<div class="mceTemp"><dl id="'+l+'" class="wp-caption '+a+i+'" style="width: '+r+'px"><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+o+"</dd></dl></div>"):n})}function m(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var n="";return-1===t.indexOf("<img ")?(n=t.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i))&&n[1]?"<p>"+n[1]+"</p>":"":-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o=n.match(/width="([0-9]*)"/);return(o=o&&o[1]?o[1]:"")&&a?'[caption id="'+(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"")+'" align="'+((t=(t=t.match(/class="([^"]*)"/))&&t[1]?t[1]:"").match(/align[a-z]+/i)||"alignnone")+'" width="'+o+'"'+(t=(t=t.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&' class="'+t+'"')+"]"+n+" "+(a=(a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]":n})).indexOf("[caption")?t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"):n})}function g(e){return e&&(e.textContent||e.innerText)}function h(e){return!e||-1===e.indexOf("<")&&-1===e.indexOf(">")?e:(t=t||new tinymce.html.Serializer({},v.schema)).serialize(v.parser.parse(e,{forced_root_block:!1}))}function u(e){var t;"DIV"===e.nodeName&&v.dom.hasClass(e,"mceTemp")?t=e:"IMG"!==e.nodeName&&"DT"!==e.nodeName&&"A"!==e.nodeName||(t=v.dom.getParent(e,"div.mceTemp")),t?(t.nextSibling?v.selection.select(t.nextSibling):t.previousSibling?v.selection.select(t.previousSibling):v.selection.select(t.parentNode),v.selection.collapse(!0),v.dom.remove(t)):v.dom.remove(e),v.nodeChanged(),v.undoManager.add()}return v.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){u(v.selection.getNode())}}),v.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){var p,e,t;p=v.selection.getNode(),"undefined"!=typeof wp&&wp.media?(t=function(e){var t,n,a,i,o=[],c=v.dom,r=/^\d+$/;(n={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=c.getAttrib(e,"src"),n.alt=c.getAttrib(e,"alt"),n.title=c.getAttrib(e,"title"),a=c.getAttrib(e,"width"),i=c.getAttrib(e,"height"),(!r.test(a)||parseInt(a,10)<1)&&(a=e.naturalWidth||e.width);(!r.test(i)||parseInt(i,10)<1)&&(i=e.naturalHeight||e.height);n.customWidth=n.width=a,n.customHeight=n.height=i,a=tinymce.explode(e.className," "),t=[],tinymce.each(a,function(e){/^wp-image/.test(e)?n.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?n.align=e.replace("align",""):/^size/.test(e)?n.size=e.replace("size-",""):t.push(e)}),n.extraClasses=t.join(" "),(i=c.getParents(e,".wp-caption")).length&&(i=i[0],a=i.className.split(" "),tinymce.each(a,function(e){/^align/.test(e)?n.align=e.replace("align",""):e&&"wp-caption"!==e&&o.push(e)}),n.captionClassName=o.join(" "),(i=c.select("dd.wp-caption-dd",i)).length&&(i=i[0],n.caption=v.serializer.serialize(i).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")));e.parentNode&&"A"===e.parentNode.nodeName&&(e=e.parentNode,n.linkUrl=c.getAttrib(e,"href"),n.linkTargetBlank="_blank"===c.getAttrib(e,"target"),n.linkRel=c.getAttrib(e,"rel"),n.linkClassName=e.className);return n}(p),wp.media.events.trigger("editor:image-edit",{editor:v,metadata:t,image:p}),e=wp.media({frame:"image",state:"image-details",metadata:t}),wp.media.events.trigger("editor:frame-create",{frame:e}),t=function(d){v.focus(),v.undoManager.transact(function(){var e,t,n,a,i,o,c,r,s,l;e=p,t=d,l=v.dom,(n=tinymce.explode(t.extraClasses," "))||(n=[]),t.caption||n.push("align"+t.align),t.attachment_id&&(n.push("wp-image-"+t.attachment_id),t.size&&"custom"!==t.size&&n.push("size-"+t.size)),c=t.width,r=t.height,"custom"===t.size&&(c=t.customWidth,r=t.customHeight),o={src:t.url,width:c||null,height:r||null,alt:t.alt,title:t.title||null,"class":n.join(" ")||null},l.setAttribs(e,o),s={href:t.linkUrl,rel:t.linkRel||null,target:t.linkTargetBlank?"_blank":null,"class":t.linkClassName||null},e.parentNode&&"A"===e.parentNode.nodeName&&!g(e.parentNode)?t.linkUrl?l.setAttribs(e.parentNode,s):l.remove(e.parentNode,!0):t.linkUrl&&((i=l.getParent(e,"a"))&&l.insertAfter(e,i),i=l.create("a",s),e.parentNode.insertBefore(i,e),i.appendChild(e)),r=v.dom.getParent(e,".mceTemp"),n=e.parentNode&&"A"===e.parentNode.nodeName&&!g(e.parentNode)?e.parentNode:e,t.caption?(t.caption=h(t.caption),o=t.attachment_id?"attachment_"+t.attachment_id:null,s="align"+(t.align||"none"),i="wp-caption "+s,t.captionClassName&&(i+=" "+t.captionClassName.replace(/[<>&]+/g,"")),v.getParam("wpeditimage_html5_captions")||(c=parseInt(c,10),c+=10),r?((s=l.select("dl.wp-caption",r)).length&&l.setAttribs(s,{id:o,"class":i,style:"width: "+c+"px"}),(s=l.select(".wp-caption-dd",r)).length&&l.setHTML(s[0],t.caption)):(a="<dl "+(o=o?'id="'+o+'" ':"")+'class="'+i+'" style="width: '+c+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+t.caption+"</dd></dl>",c=l.create("div",{"class":"mceTemp"},a),(a=l.getParent(n,"p"))?(a.parentNode.insertBefore(c,a),l.isEmpty(a)&&l.remove(a)):n.parentNode.insertBefore(c,n),v.$(c).find("dt.wp-caption-dt").append(n))):r&&(a=l.create("p"),r.parentNode.insertBefore(a,r),a.appendChild(n),l.remove(r)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:v,metadata:t,image:e}),v.nodeChanged()}),e.detach()},e.state("image-details").on("update",t),e.state("replace-image").on("replace",t),e.on("close",function(){v.focus(),e.detach()}),e.open()):v.execCommand("mceImage")}}),e({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(e,n){var t=n.slice(5);v.addButton("wp_img_"+n,{tooltip:e,icon:"dashicon dashicons-align-"+t,cmd:"alignnone"===n?"wpAlignNone":"Justify"+t.slice(0,1).toUpperCase()+t.slice(1),onPostRender:function(){var t=this;v.on("NodeChange",function(e){"IMG"===e.element.nodeName&&(e=v.dom.getParent(e.element,".wp-caption")||e.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(e.className)):t.active(v.dom.hasClass(e,n)))})}})}),(o=c.create((a=[],e(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"],function(t){function e(){var e=v.selection;t.settings.stateSelector&&e.selectorChanged(t.settings.stateSelector,function(e){t.active(e)},!0),t.settings.disabledStateSelector&&e.selectorChanged(t.settings.disabledStateSelector,function(e){t.disabled(e)})}"|"===t?n=null:c.has(t)?(t={type:t},i.toolbar_items_size&&(t.size=i.toolbar_items_size),a.push(t),n=null):(n||(n={type:"buttongroup",items:[]},a.push(n)),v.buttons[t]&&((t="function"==typeof(t=v.buttons[t])?t():t).type=t.type||"button",i.toolbar_items_size&&(t.size=i.toolbar_items_size),t=c.create(t),n.items.push(t),v.initialized?e():v.on("init",e)))}),{type:"panel",layout:"stack",classes:"toolbar-grp inline-toolbar-grp wp-image-toolbar",ariaRoot:!0,ariaRemember:!0,items:[{type:"toolbar",layout:"flow",items:a}]})).renderTo(document.body).hide()).reposition=function(){var e,t,n,a,i,o,c,r,s,l,d,p,m,g,h,u,f=this.getEl(),w=0,N=v.selection.getNode();return N&&"IMG"===N.nodeName&&(n=window.pageYOffset||document.documentElement.scrollTop,a=tinymce.$("#wpadminbar")[0],i=tinymce.$(".mce-tinymce .mce-toolbar-grp")[0],c=((o=N.getBoundingClientRect()).left+o.right)/2,r=(o.top+o.bottom)/2,s=o.top,l=void 0-o.bottom,d=window.innerWidth,m=(p=f.offsetWidth)/2,u=document.getElementById(v.id+"_ifr"),g=b.getPos(u),h=u.offsetWidth,u.offsetHeight,u=(N=f.offsetHeight)+8+5,y?e=o.top+g.y+8:u<=s?(t=" mce-arrow-down",e=o.top+g.y-N-8):u<=l?(t=" mce-arrow-up",e=o.bottom+g.y):(e=5,t=u<=r?" mce-arrow-down":" mce-arrow-up"),i=i?b.getPos(i).y+i.clientHeight:g.y,n&&i<n+(w=a&&0===a.getBoundingClientRect().top?a.clientHeight:w)&&(i=n+w),e&&i&&e<i+5&&(e=i+5,t=""),m=c-m,m+=g.x,o.left<0||o.right>h?m=g.x+(h-p)/2:d<=p?(t+=" mce-arrow-full",m=0):m<0&&o.left+p>d||d<m+p&&o.right-p<0?m=(d-p)/2:m<g.x?(t+=" mce-arrow-left",m=o.left+g.x):m+p>h+g.x&&(t+=" mce-arrow-right",m=o.right-p+g.x),y||(f.className=f.className.replace(/ ?mce-arrow-[\w]+/g,""),f.className+=t),b.setStyles(f,{left:m,top:e})),this},y&&v.on("click",function(e){var t;"IMG"===e.target.nodeName?(t=e.target,window.setTimeout(function(){v.selection.select(t)},200)):o.hide()}),v.on("nodechange",function(e){var t=y?350:100;"IMG"!==e.element.nodeName||l(e.element)?o.hide():setTimeout(function(){var e=v.selection.getNode();"IMG"!==e.nodeName||l(e)?o.hide():o._visible?o.reposition():o.show()},t)}),o.on("show",function(){r=!1,this._visible&&(this.reposition(),b.addClass(this.getEl(),"mce-inline-toolbar-grp-active"))}),o.on("hide",function(){r=!0,b.removeClass(this.getEl(),"mce-inline-toolbar-grp-active")}),o.on("keydown",function(e){27===e.keyCode&&(d(),v.focus())}),b.bind(window,"resize scroll",function(){!r&&s.hasClass("wp-editor-expand")&&d()}),v.on("init",function(){v.dom.bind(v.getWin(),"scroll",d)}),v.on("blur hide",d),v.shortcuts.add("Alt+119","",function(){var e=o.find("toolbar")[0];e&&e.focus(!0)}),v.on("init",function(){var m=v.dom,e=v.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";m.addClass(v.getBody(),e),v.on("wpLoadImageForm",function(e){v.getParam("wpeditimage_disable_captions")||e.data.splice(e.data.length-1,0,{type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"})}),v.on("wpNewImageRefresh",function(e){var t;(t=m.getParent(e.node,"dl.wp-caption"))&&(t.style.width||(e=(e=parseInt(e.node.clientWidth,10)+10)?e+"px":"50%",m.setStyle(t,"width",e)))}),v.on("wpImageFormSubmit",function(e){var t,n,a,i,o,c=e.imgData.data,r=e.imgData.node,s=e.imgData.caption,l="",d="",p="";c.id="__wp-temp-img-id",e.imgData.cancel=!0,c.style||(c.style=null),c.src?(s=s&&h(s=(s=s.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />")),r?(o=r.id||null,m.setAttribs(r,c),t=m.getParent(r,"dl.wp-caption"),s?t?(n=m.select("dd.wp-caption-dd",t)[0])&&(n.innerHTML=s):(r.className&&(l=r.className.match(/wp-image-([0-9]+)/),d=r.className.match(/align(left|right|center|none)/)),d?(d=d[0],r.className=r.className.replace(/align(left|right|center|none)/g,"")):d="alignnone",d=' class="wp-caption '+d+'"',l=l&&' id="attachment_'+l[1]+'"',(p=c.width||r.clientWidth)&&(p=parseInt(p,10),v.getParam("wpeditimage_html5_captions")||(p+=10),p=' style="width: '+p+'px"'),a=r.parentNode&&"A"===r.parentNode.nodeName?r.parentNode:r,i="<dl "+l+d+p+'><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+s+"</dd></dl>",t=m.create("div",{"class":"mceTemp"},i),(n=m.getParent(a,"p"))?(n.parentNode.insertBefore(t,n),m.isEmpty(n)&&m.remove(n)):a.parentNode.insertBefore(t,a),v.$(t).find("dt.wp-caption-dt").append(a)):t&&(i="A"===r.parentNode.nodeName?m.getOuterHTML(r.parentNode):m.getOuterHTML(r),n=m.create("p",{},i),m.insertAfter(n,t.parentNode),v.selection.select(n),v.nodeChanged(),m.remove(t.parentNode))):(i=m.createHTML("img",c),s?(a=v.selection.getNode(),c.width&&(p=parseInt(c.width,10),v.getParam("wpeditimage_html5_captions")||(p+=10),p=' style="width: '+p+'px"'),i='<dl class="wp-caption alignnone"'+p+'><dt class="wp-caption-dt">'+i+'</dt><dd class="wp-caption-dd">'+s+"</dd></dl>",(n="P"===a.nodeName?a:m.getParent(a,"p"))&&"P"===n.nodeName?(t=m.create("div",{"class":"mceTemp"},i),n.parentNode.insertBefore(t,n),v.selection.select(t),v.nodeChanged(),m.isEmpty(n)&&m.remove(n)):v.selection.setContent('<div class="mceTemp">'+i+"</div>")):v.selection.setContent(i)),r=m.get("__wp-temp-img-id"),m.setAttrib(r,"id",o),e.imgData.node=r):r&&((t=m.getParent(r,"div.mceTemp"))?m.remove(t):"A"===r.parentNode.nodeName?m.remove(r.parentNode):m.remove(r),v.nodeChanged())}),v.on("wpLoadImageData",function(e){var t=e.imgData.data,e=e.imgData.node;(e=m.getParent(e,"dl.wp-caption"))&&(e=m.select("dd.wp-caption-dd",e)[0])&&(t.caption=v.serializer.serialize(e).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}),m.bind(v.getDoc(),"dragstart",function(e){var t=v.selection.getNode();"IMG"===t.nodeName&&m.getParent(t,".wp-caption")&&e.preventDefault()}),tinymce.Env.ie&&10<tinymce.Env.ie&&m.bind(v.getBody(),"mscontrolselect",function(e){"IMG"===e.target.nodeName&&m.getParent(e.target,".wp-caption")?v.getBody().focus():"DL"===e.target.nodeName&&m.hasClass(e.target,"wp-caption")&&e.target.focus()})}),v.on("ObjectResized",function(a){var i=a.target;"IMG"===i.nodeName&&v.undoManager.transact(function(){var e,t,n=v.dom;i.className=i.className.replace(/\bsize-[^ ]+/,""),(e=n.getParent(i,".wp-caption"))&&(t=a.width||n.getAttrib(i,"width"))&&(t=parseInt(t,10),v.getParam("wpeditimage_html5_captions")||(t+=10),n.setStyle(e,"width",t+"px"))})}),v.on("BeforeExecCommand",function(e){var t,n,a=e.command,i=v.dom;"mceInsertContent"===a?(t=i.getParent(v.selection.getNode(),"div.mceTemp"))&&(n=i.create("p"),i.insertAfter(n,t),v.selection.setCursorLocation(n,0),v.nodeChanged()):"JustifyLeft"!==a&&"JustifyRight"!==a&&"JustifyCenter"!==a&&"wpAlignNone"!==a||(t=v.selection.getNode(),i="align"+a.slice(7).toLowerCase(),n=v.dom.getParent(t,".wp-caption"),"IMG"!==t.nodeName&&!n||(t=n||t,i=v.dom.hasClass(t,i)?" alignnone":" "+i,t.className=t.className.replace(/ ?align(left|center|right|none)/g,"")+i,v.nodeChanged(),e.preventDefault(),o&&o.reposition(),v.fire("ExecCommand",{command:a,ui:e.ui,value:e.value})))}),v.on("keydown",function(e){var t,n,a,i=v.selection,o=e.keyCode,c=v.dom,r=tinymce.util.VK;if(o===r.ENTER)t=i.getNode(),(n=c.getParent(t,"div.mceTemp"))&&(c.events.cancel(e),tinymce.each(c.select("dt, dd",n),function(e){c.isEmpty(e)&&c.remove(e)}),a=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',a=c.create("p",null,a),"DD"===t.nodeName?c.insertAfter(a,n):n.parentNode.insertBefore(a,n),v.nodeChanged(),i.setCursorLocation(a,0));else if((o===r.DELETE||o===r.BACKSPACE)&&("DIV"===(t=i.getNode()).nodeName&&c.hasClass(t,"mceTemp")?n=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(n=c.getParent(t,"div.mceTemp")),n))return c.events.cancel(e),u(t),!1}),tinymce.Env.gecko&&v.on("undo redo",function(){"IMG"===v.selection.getNode().nodeName&&v.selection.collapse()}),v.wpSetImgCaption=p,v.wpGetImgCaption=m,v.on("BeforeSetContent",function(e){"raw"!==e.format&&(e.content=v.wpSetImgCaption(e.content))}),v.on("PostProcess",function(e){e.get&&(e.content=v.wpGetImgCaption(e.content))}),{_do_shcode:p,_get_shcode:m}});