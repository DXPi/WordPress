window.wp=window.wp||{},function(n,o,v){"use strict";var c={},s={};o.mce=o.mce||{},o.mce.views={register:function(e,t){c[e]=o.mce.View.extend(_.extend(t,{type:e}))},unregister:function(e){delete c[e]},get:function(e){return c[e]},unbind:function(){_.each(s,function(e){e.unbind()})},setMarkers:function(e){var a,t,d=[{content:e}],r=this;return _.each(c,function(s,o){t=d.slice(),d=[],_.each(t,function(e){var t,n,i=e.content;if(e.processed)d.push(e);else{for(;i&&(t=s.prototype.match(i));)t.index&&d.push({content:i.substring(0,t.index)}),n=(a=r.createInstance(o,t.content,t.options)).loader?".":a.text,d.push({content:'<p data-wpview-marker="'+a.encodedText+'">'+n+"</p>",processed:!0}),i=i.slice(t.index+t.content.length);i&&d.push({content:i})}})}),(e=_.pluck(d,"content").join("")).replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(e,t,n){var i=this.get(e),e=this.getInstance(t);return e||(e=encodeURIComponent(t),n=_.extend(n||{},{text:t,encodedText:e}),s[e]=new i(n))},getInstance:function(e){return"string"==typeof e?s[encodeURIComponent(e)]:s[v(e).attr("data-wpview-text")]},getText:function(e){return decodeURIComponent(v(e).attr("data-wpview-text")||"")},render:function(t){_.each(s,function(e){e.render(t)})},update:function(e,t,n){var i=this.getInstance(n);i&&i.update(e,t,n)},edit:function(t,n){var i=this.getInstance(n);i&&i.edit&&i.edit(i.text,function(e){i.update(e,t,n)})},remove:function(e,t){var n=this.getInstance(t);n&&n.remove(e,t)}},o.mce.View=function(e){_.extend(this,e),this.initialize()},o.mce.View.extend=Backbone.View.extend,_.extend(o.mce.View.prototype,{content:null,loader:!0,initialize:function(){},getContent:function(){return this.content},render:function(e,t){null!=e&&(this.content=e),e=this.getContent(),(this.loader||e)&&(t&&this.unbind(),this.replaceMarkers(),e?this.setContent(e,function(e,t,n){v(t).data("rendered",!0),this.bindNode.call(this,e,t,n)},!!t&&null):this.setLoader())},bindNode:function(){},unbindNode:function(){},unbind:function(){this.getNodes(function(e,t,n){this.unbindNode.call(this,e,t,n),v(t).trigger("wp-mce-view-unbind")},!0)},getEditors:function(t){_.each(tinymce.editors,function(e){e.plugins.wpview&&t.call(this,e)},this)},getNodes:function(n,i){this.getEditors(function(e){var t=this;v(e.getBody()).find('[data-wpview-text="'+t.encodedText+'"]').filter(function(){var e;return null==i||(e=!0===v(this).data("rendered"),i?e:!e)}).each(function(){n.call(t,e,this,v(this).find(".wpview-content").get(0))})})},getMarkers:function(n){this.getEditors(function(e){var t=this;v(e.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){n.call(t,e,this)})})},replaceMarkers:function(){this.getMarkers(function(e,t){this.loader||v(t).text()===tinymce.DOM.decode(this.text)?e.dom.replace(e.dom.createFragment('<div class="wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'"><p class="wpview-selection-before">\xa0</p><div class="wpview-body" contenteditable="false"><div class="wpview-content wpview-type-'+this.type+'"></div></div><p class="wpview-selection-after">\xa0</p></div>'),t):e.dom.setAttrib(t,"data-wpview-marker",null)})},removeMarkers:function(){this.getMarkers(function(e,t){e.dom.setAttrib(t,"data-wpview-marker",null)})},setContent:function(i,s,e){_.isObject(i)&&-1!==i.body.indexOf("<script")?this.setIframes(i.head||"",i.body,s,e):_.isString(i)&&-1!==i.indexOf("<script")?this.setIframes("",i,s,e):this.getNodes(function(e,t,n){-1!==(i=i.body||i).indexOf("<iframe")&&(i+='<div class="wpview-overlay"></div>'),n.innerHTML="",n.appendChild(_.isString(i)?e.dom.createFragment(i):i),s&&s.call(this,e,t,n)},e)},setIframes:function(p,h,f,e){var t,w=n.MutationObserver||n.WebKitMutationObserver||n.MozMutationObserver,m=this;-1!==h.indexOf("[")&&-1!==h.indexOf("]")&&(t=new RegExp("\\[\\/?(?:"+n.mceViewL10n.shortcodes.join("|")+")[^\\]]*?\\]","g"),h=h.replace(t,function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")})),this.getNodes(function(a,d,r){var c=a.dom,u="",l=a.getBody().className||"",e=a.getDoc().getElementsByTagName("head")[0];tinymce.each(c.$('link[rel="stylesheet"]',e),function(e){e.href&&-1===e.href.indexOf("skins/lightgray/content.min.css")&&-1===e.href.indexOf("skins/wordpress/wp-content.css")&&(u+=c.getOuterHTML(e))}),setTimeout(function(){var n,i,e,t;function s(){var e,t;n.contentWindow&&(e=v(n),t=v(i.body).height(),e.height()!==t&&(e.height(t),a.nodeChanged()))}if(r.innerHTML="",n=c.add(r,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"}}),c.add(r,"div",{"class":"wpview-overlay"}),(i=n.contentWindow.document).open(),i.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+p+u+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+l+'">'+h+"</body></html>"),i.close(),v(n.contentWindow).on("load",s),w)(e=new w(_.debounce(s,100))).observe(i.body,{attributes:!0,childList:!0,subtree:!0}),v(d).one("wp-mce-view-unbind",function(){e.disconnect()});else for(t=1;t<6;t++)setTimeout(s,700*t);function o(){i.body.className=a.getBody().className}a.on("wp-body-class-change",o),v(d).one("wp-mce-view-unbind",function(){a.off("wp-body-class-change",o)}),f&&f.call(m,a,d,r)},50)},e)},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-admin-media"></div><div class="wpview-loading"><ins></ins></div></div>')},setError:function(e,t){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(t||"no")+'"></div><p>'+e+"</p></div>")},match:function(e){e=o.shortcode.next(this.type,e);if(e)return{index:e.index,content:e.content,options:{shortcode:e.shortcode}}},update:function(n,i,s){_.find(c,function(e,t){e=e.prototype.match(n);if(e)return v(s).data("rendered",!1),i.dom.setAttrib(s,"data-wpview-text",encodeURIComponent(n)),o.mce.views.createInstance(t,n,e.options).render(),i.focus(),!0})},remove:function(e,t){this.unbindNode.call(this,e,t,v(t).find(".wpview-content").get(0)),v(t).trigger("wp-mce-view-unbind"),e.dom.remove(t),e.focus()}})}(window,window.wp,window.jQuery),function(e,i){var s=i("#post_ID").val()||0,t={state:[],edit:function(e,t){var n=wp.media[this.type],i=n.edit(e);this.pausePlayers&&this.pausePlayers(),_.each(this.state,function(e){i.state(e).on("update",function(e){t(n.shortcode(e).string())})}),i.on("close",function(){i.detach()}),i.open()}},n=_.extend({},t,{state:["gallery-edit"],template:wp.media.template("editor-gallery"),initialize:function(){var e=wp.media.gallery.attachments(this.shortcode,s),t=this.shortcode.attrs.named,n=this;e.more().done(function(){e=e.toJSON(),_.each(e,function(e){e.sizes&&(t.size&&e.sizes[t.size]?e.thumbnail=e.sizes[t.size]:e.sizes.thumbnail?e.thumbnail=e.sizes.thumbnail:e.sizes.full&&(e.thumbnail=e.sizes.full))}),n.render(n.template({attachments:e,columns:t.columns?parseInt(t.columns,10):wp.media.galleryDefaults.columns}))}).fail(function(e,t){n.setError(t)})}}),o=_.extend({},t,{action:"parse-media-shortcode",initialize:function(){var t=this;this.url&&(this.loader=!1,this.shortcode=wp.media.embed.shortcode({url:this.text})),wp.ajax.post(this.action,{post_ID:s,type:this.shortcode.tag,shortcode:this.shortcode.string()}).done(function(e){t.render(e)}).fail(function(e){t.url?t.removeMarkers():t.setError(e.message||e.statusText,"admin-media")}),this.getEditors(function(e){e.on("wpview-selected",function(){t.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(e,t,n){n=i("iframe.wpview-sandbox",n).get(0);(n=n&&n.contentWindow)&&n.mejs&&_.each(n.mejs.players,function(e){try{e.pause()}catch(e){}})})}}),t=_.extend({},o,{action:"parse-embed",edit:function(e,t){var n=wp.media.embed,i=n.edit(e,this.url),s=this;this.pausePlayers(),i.state("embed").props.on("change:url",function(e,t){t&&e.get("url")&&(i.state("embed").metadata=e.toJSON())}),i.state("embed").on("select",function(){var e=i.state("embed").metadata;s.url?t(e.url):t(n.shortcode(e).string())}),i.on("close",function(){i.detach()}),i.open()}});e.register("gallery",_.extend({},n)),e.register("audio",_.extend({},o,{state:["audio-details"]})),e.register("video",_.extend({},o,{state:["video-details"]})),e.register("playlist",_.extend({},o,{state:["playlist-edit","video-playlist-edit"]})),e.register("embed",_.extend({},t)),e.register("embedURL",_.extend({},t,{match:function(e){e=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi.exec(e);if(e)return{index:e.index+e[1].length,content:e[2],options:{url:!0}}}}))}((window,window.wp.mce.views),window.jQuery);