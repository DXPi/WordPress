window.wp=window.wp||{},function(u){"use strict";var n={},o={},a=wp.media,i=[],s=0,t=["encodedText"];wp.mce=wp.mce||{},wp.mce.View=function(e){e=e||{},this.type=e.type,_.extend(this,_.pick(e,t)),this.initialize.apply(this,arguments)},_.extend(wp.mce.View.prototype,{initialize:function(){},getHtml:function(){return""},loadingPlaceholder:function(){return'<div class="loading-placeholder"><div class="dashicons dashicons-admin-media"></div><div class="wpview-loading"><ins></ins></div></div>'},render:function(e){!e&&this.rendered()||(this.unbind(),this.setContent('<p class="wpview-selection-before"> </p><div class="wpview-body" contenteditable="false"><div class="toolbar mce-arrow-down">'+(_.isFunction(n[this.type].edit)?'<div class="dashicons dashicons-edit edit"></div>':"")+'<div class="dashicons dashicons-no remove"></div></div><div class="wpview-content wpview-type-'+this.type+'">'+(this.getHtml()||this.loadingPlaceholder())+"</div>"+(this.overlay?'<div class="wpview-overlay"></div>':"")+'</div><p class="wpview-selection-after"> </p>',"wrap"),u(this).trigger("ready"),this.rendered(!0))},unbind:function(){},getEditors:function(t){var i=[];return _.each(tinymce.editors,function(e){e.plugins.wpview&&(t&&t(e),i.push(e))},this),i},getNodes:function(n){var s=[],e=this;return this.getEditors(function(i){u(i.getBody()).find('[data-wpview-text="'+e.encodedText+'"]').each(function(e,t){n&&n(i,t,u(t).find(".wpview-content").get(0)),s.push(t)})}),s},setContent:function(n,s){this.getNodes(function(e,t,i){t="wrap"===s||"replace"===s?t:i,i=n;_.isString(i)&&(i=e.dom.createFragment(i)),"replace"===s?e.dom.replace(i,t):(t.innerHTML="",t.appendChild(i))})},setIframes:function(h,p){var e,w=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,l="video"===this.type||"audio"===this.type||"playlist"===this.type;h||-1!==p.indexOf("<script")?(-1!==p.indexOf("[")&&-1!==p.indexOf("]")&&(e=new RegExp("\\[\\/?(?:"+window.mceViewL10n.shortcodes.join("|")+")[^\\]]*?\\]","g"),p=p.replace(e,function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")})),this.getNodes(function(e,t,i){var n,s,o,a,d=e.dom,r="",c=e.getBody().className||"";i.innerHTML="",h=h||"",l&&(wp.mce.views.sandboxStyles?r=wp.mce.views.sandboxStyles:(tinymce.each(d.$('link[rel="stylesheet"]',e.getDoc().head),function(e){e.href&&-1===e.href.indexOf("skins/lightgray/content.min.css")&&-1===e.href.indexOf("skins/wordpress/wp-content.css")&&(r+=d.getOuterHTML(e)+"\n")}),wp.mce.views.sandboxStyles=r)),setTimeout(function(){if(n=d.add(i,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"}}),(s=n.contentWindow.document).open(),s.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+h+r+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+c+'">'+p+"</body></html>"),s.close(),a=function(){n.contentWindow&&u(n).height(u(s.body).height())},w)new w(_.debounce(function(){a()},100)).observe(s.body,{attributes:!0,childList:!0,subtree:!0});else for(o=1;o<6;o++)setTimeout(a,700*o);l&&e.on("wp-body-class-change",function(){s.body.className=e.getBody().className})},50)})):this.setContent(p)},setError:function(e,t){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(t||"no")+'"></div><p>'+e+"</p></div>")},rendered:function(i){var n;return this.getNodes(function(e,t){null!=i?u(t).data("rendered",!0===i):n=n||!u(t).data("rendered")}),!n}}),wp.mce.View.extend=Backbone.View.extend,wp.mce.views={register:function(e,t){var i={type:e,View:{},toView:function(e){e=wp.shortcode.next(this.type,e);if(e)return{index:e.index,content:e.content,options:{shortcode:e.shortcode}}}};(t=_.defaults(t,i)).View=wp.mce.View.extend(t.View),n[e]=t},get:function(e){return n[e]},unregister:function(e){delete n[e]},unbind:function(){_.each(o,function(e){e.unbind()})},toViews:function(e){var t,o=[{content:e}];return _.each(n,function(n,s){t=o.slice(),o=[],_.each(t,function(e){var t,i=e.content;if(e.processed)o.push(e);else{for(;i&&(t=n.toView(i));)t.index&&o.push({content:i.substring(0,t.index)}),o.push({content:wp.mce.views.toView(s,t.content,t.options),processed:!0}),i=i.slice(t.index+t.content.length);i&&o.push({content:i})}})}),_.pluck(o,"content").join("")},toView:function(e,t,i){var n=wp.mce.views.get(e),s=window.encodeURIComponent(t);return n?(wp.mce.views.getInstance(s)||((i=i).type=e,i.encodedText=s,i=new n.View(i),o[s]=i),wp.html.string({tag:"div",attrs:{"class":"wpview-wrap","data-wpview-text":s,"data-wpview-type":e},content:" "})):t},refreshView:function(e,t,i){var n=window.encodeURIComponent(t),s=wp.mce.views.getInstance(n);s||((t=e.toView(t).options).type=e.type,t.encodedText=n,s=new e.View(t),o[n]=s),s.render(i)},getInstance:function(e){return o[e]},render:function(t){_.each(o,function(e){e.render(t)})},edit:function(e){var t=u(e).data("wpview-type"),t=wp.mce.views.get(t);t&&t.edit(e)}},wp.mce.views.register("gallery",{View:{template:a.template("editor-gallery"),postID:u("#post_ID").val(),initialize:function(e){this.shortcode=e.shortcode,this.fetch()},fetch:function(){var e=this;this.attachments=wp.media.gallery.attachments(this.shortcode,this.postID),this.dfd=this.attachments.more().done(function(){e.render(!0)})},getHtml:function(){var t=this.shortcode.attrs.named,e=!1;return this.dfd&&"pending"===this.dfd.state()&&!this.attachments.length?"":(this.attachments.length&&(e=this.attachments.toJSON(),_.each(e,function(e){e.sizes&&(t.size&&e.sizes[t.size]?e.thumbnail=e.sizes[t.size]:e.sizes.thumbnail?e.thumbnail=e.sizes.thumbnail:e.sizes.full&&(e.thumbnail=e.sizes.full))})),e={attachments:e,columns:t.columns?parseInt(t.columns,10):wp.media.galleryDefaults.columns},this.template(e))}},edit:function(i){var n=wp.media.gallery,s=this,o=window.decodeURIComponent(u(i).attr("data-wpview-text")),e=n.edit(o);e.state("gallery-edit").on("update",function(e){var t=n.shortcode(e).string();u(i).attr("data-wpview-text",window.encodeURIComponent(t)),e=o!==t,wp.mce.views.refreshView(s,t,e)}),e.on("close",function(){e.detach()})}}),wp.mce.av={View:{overlay:!0,action:"parse-media-shortcode",initialize:function(e){var t=this;this.shortcode=e.shortcode,_.bindAll(this,"setIframes","setNodes","fetch","stopPlayers"),u(this).on("ready",this.setNodes),u(document).on("media:edit",this.stopPlayers),this.fetch(),this.getEditors(function(e){e.on("hide",function(){i=[],s=0,t.stopPlayers()})})},pauseOtherWindows:function(t){_.each(i,function(e){e.sandboxId!==t.sandboxId&&_.each(e.mejs.players,function(e){e.pause()})})},iframeLoaded:function(e){return _.bind(function(){var t;e.mejs&&!_.isEmpty(e.mejs.players)&&(e.sandboxId=s,s++,i.push(e),t=_.bind(function(){this.pauseOtherWindows(e)},this),_.isEmpty(e.mejs.MediaPluginBridge.pluginMediaElements)||_.each(e.mejs.MediaPluginBridge.pluginMediaElements,function(e){e.addEventListener("play",t)}),_.each(e.mejs.players,function(e){u(e.node).on("play",t)},this))},this)},listenToSandboxes:function(){_.each(this.getNodes(),function(e){var t,e=u(".wpview-sandbox",e).get(0);e&&(t=e.contentWindow)&&u(t).load(_.bind(this.iframeLoaded(t),this))},this)},deferredListen:function(){window.setTimeout(_.bind(this.listenToSandboxes,this),50*this.getNodes().length)},setNodes:function(){this.parsed?(this.setIframes(this.parsed.head,this.parsed.body),this.deferredListen()):this.fail()},fetch:function(){var t=this;wp.ajax.send(this.action,{data:{post_ID:u("#post_ID").val()||0,type:this.shortcode.tag,shortcode:this.shortcode.string()}}).done(function(e){e?(t.parsed=e,t.setIframes(e.head,e.body),t.deferredListen()):t.fail(!0)}).fail(function(e){t.fail(e||!0)})},fail:function(e){if(!this.error){if(!e)return;this.error=e}this.error.message?"not-embeddable"===this.error.type&&"embed"===this.type||"not-ssl"===this.error.type||"no-items"===this.error.type?this.setError(this.error.message,"admin-media"):this.setContent("<p>"+this.original+"</p>","replace"):this.error.statusText?this.setError(this.error.statusText,"admin-media"):this.original&&this.setContent("<p>"+this.original+"</p>","replace")},stopPlayers:function(e){var o="remove"===e;this.getNodes(function(e,t,i){var n,s,i=u("iframe.wpview-sandbox",i).get(0);if(i&&(s=i.contentWindow)&&s.mejs)try{for(n in s.mejs.players)s.mejs.players[n].pause(),o&&s.mejs.players[n].remove()}catch(e){}})},unbind:function(){this.stopPlayers("remove")}},edit:function(t){var i,e,n,s=wp.media[this.type],o=this;u(document).trigger("media:edit"),e=window.decodeURIComponent(u(t).attr("data-wpview-text")),(i=s.edit(e)).on("close",function(){i.detach()}),n=function(e){e=wp.media[o.type].shortcode(e).string();u(t).attr("data-wpview-text",window.encodeURIComponent(e)),wp.mce.views.refreshView(o,e),i.detach()},_.isArray(o.state)?_.each(o.state,function(e){i.state(e).on("update",n)}):i.state(o.state).on("update",n),i.open()}},wp.mce.views.register("video",_.extend({},wp.mce.av,{state:"video-details"})),wp.mce.views.register("audio",_.extend({},wp.mce.av,{state:"audio-details"})),wp.mce.views.register("playlist",_.extend({},wp.mce.av,{state:["playlist-edit","video-playlist-edit"]})),wp.mce.embedMixin={View:_.extend({},wp.mce.av.View,{overlay:!0,action:"parse-embed",initialize:function(e){this.content=e.content,this.original=e.url||e.shortcode.string(),e.url?this.shortcode=a.embed.shortcode({url:e.url}):this.shortcode=e.shortcode,_.bindAll(this,"setIframes","setNodes","fetch"),u(this).on("ready",this.setNodes),this.fetch()}}),edit:function(t){var i,e,n=a.embed,s=this,o="embedURL"===this.type;u(document).trigger("media:edit"),e=window.decodeURIComponent(u(t).attr("data-wpview-text")),(i=n.edit(e,o)).on("close",function(){i.detach()}),i.state("embed").props.on("change:url",function(e,t){t&&(i.state("embed").metadata=e.toJSON())}),i.state("embed").on("select",function(){var e=o?i.state("embed").metadata.url:n.shortcode(i.state("embed").metadata).string();u(t).attr("data-wpview-text",window.encodeURIComponent(e)),wp.mce.views.refreshView(s,e),i.detach()}),i.open()}},wp.mce.views.register("embed",_.extend({},wp.mce.embedMixin)),wp.mce.views.register("embedURL",_.extend({},wp.mce.embedMixin,{toView:function(e){e=/(?:^|<p>)(https?:\/\/[^\s"]+?)(?:<\/p>\s*|$)/gi.exec(tinymce.trim(e));if(e)return{index:e.index,content:e[0],options:{url:e[1]}}}}))}(jQuery);